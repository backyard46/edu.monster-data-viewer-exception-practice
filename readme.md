# 概要

ITSS準拠の研修カリキュラム「プログラミングの基礎(1)（B121）」のうち、「例外処理」に関する課題と正解例です。

# 課題

## 事前準備
- 子フォームを作り、接続設定変更機能を実装してもらいます、。そのため、事前に [EDU. Transfer data between forms](https://gitlab.com/it_education/edu.-transfer-data-between-forms) のフォーム間情報連携に関するサンプルコードの解説を行い、フォーム同士での情報連携について理解させてください。
- 研修環境からアクセス可能なSQL Serverに、「Database」ディレクトリにある下記のSQL 2件でテーブルとデータを作成してください。
  - TableCreate.sql …… Monstersテーブルを生成するCreate文です。
  - DataInsert.sql …… Monstersテーブルにポケモンデータを登録するInsert文です。
- MonsterViewer.cs / SimpleSearchの「connectionString」変数に接続先サーバー情報が記述されているので、用意した環境のサーバー、DB名、ID、パスワードに書き換えてください。
- 同じく、Properties / Settings.settings にある接続先情報も書き換えてください。
- 課題用ソースを受講者に配布し、Visual Studioで開ける状態にしてください。



## 課題1: プログラムを動かす

### 新人用課題文
MonsterViewer.csファイルの冒頭、「// データベース接続用情報」部分に記載されたサーバー名、データベース名、ユーザーID、パスワードをそれぞれ自分のID等に書き換えてください。書き換え後、プログラムをVisual Studio上で起動し、表示ボタンを押してデータベースのデータが一覧表示されることを確認してください。

### 講師用補足
まずは動作することの確認を行いますが、必ず事前に講師用アカウントで接続できることを確認しておいてください。接続できない場合、新人の記入不備等である可能性がありますが、以下のようなチェックを行って問題発生時の確認手順をたどる経験をさせても良いかも知れません。

- データベースサーバー自体が稼働していることを確認する（サーバー自体にpingを打つ）。
- SQL Server Management Studioからデータを確認し、SQL Server自体が動いていること、アカウント情報に誤りが無いことと、データが存在することを確認する。



## 課題2: 接続先設定機能追加

### 新人用課題文
現在のプログラムは接続先データベースやアカウント情報がプログラムに埋め込まれているので、変更が面倒です。これを、利用者が自由に書き換えられるよう、接続先設定機能を追加してください。具体的には

- 接続先設定のボタンを用意する。
- ボタンが押されると、新しいウィンドウが開く。
- ウィンドウ上でサーバー名、データベース名、ユーザーID、パスワードを入力し、ウィンドウを閉じると親画面の接続先設定が変更される。

というものです。

### 講師用補足
子フォームを作り、親フォームに情報を伝えるという実装になりますが、新規フォームの作成や表示等については知識が足りない可能性があるので、サポートするか調べ方についてアドバイスをしてあげてください。



## 課題3: データ取得時の例外処理追加

### 新人用課題文
データベースからデータを取得している処理をTry、Catchで囲み、下記のような場合にメッセージ「データベースからデータを取得できません。」が表示されるようにしてください。

- サーバー名を間違えている。
- データベース名を間違えている。
- ユーザーIDかパスワードを間違えている。

間違えた情報の設定には課題2で作った設定画面を使ってください。
なお、SQL Serverデータベースに接続失敗した場合、SqlExceptionという例外が発生します。catch句ではSqlExceptionをキャッチしてエラー処理を行うようにしてください（そうでないと、データベースに関係ない不具合での例外であっても「データベースから……」というメッセージが出てしまいます）。

### 講師用補足
Try/Catchでの例外処理です。できればファイルのクローズ処理なども絡めてFinallyも有効活用するようなサンプルにがあれば良いのですが、ファイル操作などは別の課題として用意しているので、あまりこの課題に詰め込みすぎないよう、あえてシンプルにしています。



## 課題4: 設定情報の保存

### 新人用課題文
課題2の機能で入力された接続先情報を設定ファイルに保存し、次回から前回入力した情報が初期設定されるように改造します。下記の手順で処理を追加してみてください。

1. Visual Studioで「ソリューションエクスプローラー」からプロジェクトを右クリック、「プロパティ」を選択します。
1. 設定項目として「ServerName」「DatabaseName」「UserID」「Password」を文字列型で追加します。
1. プログラムが終了される際に発生する「Closing」イベントに、下記のようにして設定情報を保存する処理を追記します（例はServerNameですが他の項目も同様に追記してください）。
    ```cs
    // サーバー名を設定ファイルに保存
    Properties.Settings.Default["ServerName"] = serverName;
    Properties.Settings.Default.Save();
    ```
1. プログラム起動時に発生する「Load」イベントに、下記のように設定情報をファイルから読み込む処理を追記します（例はServerNameですが他の項目も同様に追記してください）。
    ```cs
    // サーバー名を設定ファイルから読み込む
    serverName = Properties.Settings.Default["ServerName"].ToString();
    ```

### 講師用補足
設定情報の保存と読み込み処理です。ゲームなどでいういわゆる「セーブデータ」に相当する物が、.NET Frameworkの機能を使うと簡単に作れる事を学びます。



## 課題5: 設定情報保存場所確認

### 新人用課題文
課題4で設定情報を設定ファイルに保存するようにしましたが、実際に、設定情報はどこに保存されているか探してみてください。確認に際しては、下記の手順で「単独で動く実行形式のプログラム（拡張子が.exeのファイル）」を作り、それに関する設定を確認してください。

1. ソースをVisual Studioで開きます。
1. 画面上部の「Debug」「Release」のドロップダウンリストを「Release」に切り替えてください。
1. ソースを「リビルド」してください。
1. Windowsエクスプローラーでソースファイルがあるフォルダを開き、「bin/Release」フォルダを表示してください。
1. そこに「MonsterDataViewer.exe」ができていますので、実行して設定情報を書き換えてください。
1. 書き換えた情報がどこに保存されているかを探してください。

### 講師用補足
.NET Frameworkの標準機能を用いて作成した設定情報は、exeファイルと同じフォルダにある「プログラム名.exe.config」ファイルにXML形式で保管されます。このファイルはVisual Studioのソリューションエクスプローラー上では「app.config」という名前になっており、ビルドの際に「プログラム名.exe.config」に改名されます。そのあたりの関連についても可能であれば示唆して認識させてあげてください。